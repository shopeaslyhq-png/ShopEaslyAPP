<% layout('layout') %>
<link rel="stylesheet" href="/css/assistant.css" nonce="<%= cspNonce %>">

<div class="page-container ai-theme">
    <div class="ai-assistant-container">
        <!-- Header -->
        <header class="ai-header">
            <div class="ai-header-content">
                <div class="ai-title-section">
                    <img class="ai-logo" src="/images/shopeasly-logo.png" alt="Easly AI" />
                    <div class="ai-title-text">
                        <h1>Easly AI</h1>
                        <p>Creative + Operations Copilot</p>
                    </div>
                </div>
                <div class="ai-header-actions">
                    <button id="panelToggleBtn" title="Toggle side panel" aria-expanded="true">Panel ‚ñæ</button>
                    <button id="openProductWizardBtn" class="btn btn-primary">+ Product</button>
                    <button id="openBulkCreationBtn" class="btn btn-secondary" title="Create multiple products">üì¶ Bulk</button>
                    <div class="ai-mode-controls" style="display:flex;align-items:center;gap:.5rem;margin-left:.75rem;">
                        <label title="Send messages to the architect tool-loop endpoint" style="display:flex;align-items:center;gap:.35rem;cursor:pointer;user-select:none;font-size:.9rem;color:var(--text-secondary);">
                            <input type="checkbox" id="archModeToggle" style="margin:0;">
                            <span>Architect mode</span>
                        </label>
                        <span class="badge" style="background:#1e3a8a;color:#fff;padding:4px 8px;border-radius:6px;font-size:.65rem;letter-spacing:.5px;">ADMIN</span>
                        <span id="eventsStatusDot" class="status-dot" title="Real-time: unknown" style="display:inline-block;width:10px;height:10px;border-radius:50%;background:#bbb;box-shadow:0 0 0 2px rgba(0,0,0,.05);"></span>
                    </div>
                </div>
            </div>
        </header>

        <!-- Main layout: chat left, panel right -->
        <div class="ai-layout">
            <!-- Chat column -->
            <section class="ai-chat-container" aria-label="Chat">
                <button id="jumpLatestBtn" class="jump-latest-btn" aria-label="Jump to latest messages">‚Üì New</button>
                <div class="ai-chat-history" id="ai-chat-history" role="log" aria-live="polite" aria-relevant="additions">
                    <!-- Welcome message -->
                    <div class="chat-message ai-message">
                        <div class="message-avatar"><div class="avatar-ai">ü§ñ</div></div>
                        <div class="message-content">
                            <div class="message-header">
                                <span class="sender-name">Easly AI</span>
                                <span class="message-time">Just now</span>
                            </div>
                            <div class="message-text"><p>Welcome! How can I help you today?</p></div>
                        </div>
                    </div>
                </div>

                <!-- Composer -->
                <div class="ai-input-section">
                    <form id="ai-form" class="ai-form">
                        <div class="input-wrapper">
                            <textarea id="ai-input" class="form-input ai-input" rows="1" placeholder="Message Easly‚Ä¶" aria-label="Type a message" autocomplete="off" autocapitalize="sentences" spellcheck="true" maxlength="4000"></textarea>
                            <div class="input-actions">
                                <button type="button" class="attach-btn" id="attachBtn" title="Attach image" aria-label="Attach image">üìé</button>
                                <button type="button" class="attach-btn" id="openGenBtn" title="Generate design image" aria-label="Generate design image">üñºÔ∏è</button>
                                <button type="button" class="voice-btn" id="voiceBtn" data-voice-toggle title="Voice Input" aria-label="Start voice input"><span class="voice-icon">üé§</span></button>
                                <button type="submit" class="send-btn" id="sendBtn" title="Send Message" aria-label="Send message" disabled><span class="send-icon">‚û§</span></button>
                            </div>
                        </div>
                    </form>
                    <input type="file" id="imageInput" accept="image/*" style="display:none" />
                    <div id="attachmentPreview" class="attachment-preview" style="display:none"></div>

                    <!-- Voice Status -->
                    <div class="voice-status" id="voiceStatus" style="display: none;">
                        <div class="voice-animation"><div class="voice-wave"></div><div class="voice-wave"></div><div class="voice-wave"></div></div>
                        <span class="voice-text">Listening...</span>
                    </div>
                </div>
            </section>
            
            <!-- Bulk creation moved to dedicated modal (#bulkCreationModal) to prevent duplication & ID collisions -->
        </div>
    </div>

<!-- Side panel markup intentionally removed here: it should exist only once in final cleaned template (provided earlier in refactor) -->

<!-- Loading Overlay -->
<div class="ai-loading-overlay" id="loadingOverlay" style="display: none;">
    <div class="loading-content">
        <div class="ai-thinking-animation">
            <div class="thinking-dots">
                <div class="dot"></div>
                <div class="dot"></div>
                <div class="dot"></div>
            </div>
        </div>
        <p>AI is thinking...</p>
    </div>
</div>

</div>

<!-- Settings Modal -->
<div id="settingsModal" class="modal-overlay" style="display: none;" aria-hidden="true" role="dialog" aria-modal="true">
    <div class="modal-content">
        <button class="modal-close-btn" id="closeSettingsBtn" aria-label="Close settings">√ó</button>
        <h2 style="margin-bottom: 1rem;">Settings</h2>
        <div class="settings-options">
            <label class="setting-item">
                <input type="checkbox" id="voiceResponsesToggle" onchange="updateSetting('voiceResponses', this.checked)">
                <span>Voice responses</span>
            </label>
            <label class="setting-item">
                <input type="checkbox" id="autoSuggestionsToggle" onchange="updateSetting('autoSuggestions', this.checked)">
                <span>Auto-suggestions</span>
            </label>
            <label class="setting-item">
                <input type="checkbox" id="showTimestampsToggle" onchange="updateSetting('showTimestamps', this.checked)">
                <span>Show timestamps</span>
            </label>
        </div>
    </div>
    
</div>

<!-- Image Generator Modal -->
<div id="imageGenModal" class="modal-overlay" style="display: none;" aria-hidden="true" role="dialog" aria-modal="true">
    <div class="modal-content">
        <button class="modal-close-btn" id="closeImageGenBtn" aria-label="Close image generator">√ó</button>
        <h2 style="margin-bottom: 1rem;">Generate Design Image</h2>
        <form id="imageGenForm">
            <div class="form-group">
                <label for="genDescription">Describe the design</label>
                <input id="genDescription" class="form-input" type="text" placeholder="e.g., retro space astronaut with neon colors" required />
            </div>
            <div class="form-group">
                <label for="genProduct">Target product (optional)</label>
                <select id="genProduct" class="form-input">
                    <option value="">(none)</option>
                    <option value="t-shirt">T-Shirt</option>
                    <option value="hoodie">Hoodie</option>
                    <option value="mug">Mug</option>
                    <option value="sticker">Sticker</option>
                    <option value="poster">Poster</option>
                </select>
            </div>
            <div class="form-actions">
                <button type="submit" class="btn btn-primary">Generate</button>
            </div>
        </form>
        <small class="text-muted">Images are generated using your configured provider and saved locally for easy reuse.</small>
    </div>
</div>

<!-- Product Wizard Modal -->
<div id="productWizard" class="modal-overlay" style="display:none;" aria-hidden="true" role="dialog" aria-modal="true">
    <div class="modal-content" style="max-width:720px; width:95vw;">
        <button class="modal-close-btn" id="closeProductWizard" aria-label="Close product wizard">√ó</button>
        <div class="wizard-header">
            <h2>Create Product</h2>
            <div class="wizard-progress">
                <div class="progress-bar">
                    <div class="progress-fill" id="pw-progress"></div>
                </div>
                <span class="progress-text" id="pw-progress-text">Step 1 of 5</span>
            </div>
        </div>
        <ol id="pw-steps" style="display:flex; gap:0.75rem; list-style:none; padding:0; margin:0 0 1rem 0;">
            <li class="pw-step" data-step="1"><span class="step-icon">üì∑</span>Image</li>
            <li class="pw-step" data-step="2"><span class="step-icon">üß±</span>Materials</li>
            <li class="pw-step" data-step="3"><span class="step-icon">üè∑Ô∏è</span>Details</li>
            <li class="pw-step" data-step="4"><span class="step-icon">ü§ñ</span>AI Assist</li>
            <li class="pw-step" data-step="5"><span class="step-icon">‚úÖ</span>Review</li>
        </ol>
        <div id="pw-body">
            <!-- Step 1: Image -->
            <section class="pw-panel" data-step="1">
                <div class="step-header">
                    <h3>Product Image</h3>
                    <p class="step-description">Add or generate an image for your product</p>
                </div>
                
                <div class="image-options">
                    <div class="form-group">
                        <label class="form-label-enhanced">üìÅ Upload existing image</label>
                        <input type="file" id="pw-upload" accept="image/*" class="form-input" />
                        <small class="form-hint">Supports JPG, PNG, GIF (max 10MB)</small>
                    </div>
                    
                    <div class="divider">OR</div>
                    
                    <div class="form-group">
                        <label class="form-label-enhanced">üé® Generate with AI</label>
                        <div class="input-with-button">
                            <input type="text" id="pw-gen-prompt" class="form-input" placeholder="e.g., retro astronaut neon style for t-shirt" />
                            <button class="btn btn-secondary" id="pw-generate">
                                <span class="btn-icon">‚ú®</span>Generate
                            </button>
                        </div>
                        <small class="form-hint">Describe the style and theme for AI image generation</small>
                    </div>
                </div>
                
                <div id="pw-image-preview" class="image-preview-enhanced" style="display:none;">
                    <img id="pw-image" src="" alt="preview" />
                    <div class="image-actions">
                        <button class="btn btn-sm btn-secondary" id="pw-regenerate">üîÑ Regenerate</button>
                        <button class="btn btn-sm btn-secondary" id="pw-remove-image">üóëÔ∏è Remove</button>
                    </div>
                </div>
            </section>
            
            <!-- Step 2: Materials & Packaging -->
            <section class="pw-panel hidden" data-step="2">
                <div class="step-header">
                    <h3>Materials & Packaging</h3>
                    <p class="step-description">Select materials and packaging for this product</p>
                </div>
                
                <div class="materials-section">
                    <div class="form-group">
                        <label class="form-label-enhanced">üß± Required Materials</label>
                        <div id="pw-materials" class="selection-list"></div>
                        <div class="materials-summary" id="pw-materials-summary" style="display:none;">
                            <span class="summary-text">0 materials selected</span>
                            <span class="estimated-cost">Est. cost: $0.00</span>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label-enhanced">üì¶ Packaging (optional)</label>
                        <div id="pw-packaging" class="selection-list"></div>
                    </div>
                </div>
            </section>
            
            <!-- Step 3: Product Details -->
            <section class="pw-panel hidden" data-step="3">
                <div class="step-header">
                    <h3>Product Details</h3>
                    <p class="step-description">Basic product information</p>
                </div>
                
                <div class="product-details-form">
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label-enhanced">üìù Product Name</label>
                            <input type="text" id="pw-name-manual" class="form-input" placeholder="e.g., Vintage Space T-Shirt" />
                        </div>
                        <div class="form-group">
                            <label class="form-label-enhanced">üè∑Ô∏è Category</label>
                            <select id="pw-category" class="form-input">
                                <option value="Apparel">üëï Apparel</option>
                                <option value="Accessories">üëú Accessories</option>
                                <option value="Drinkware">‚òï Drinkware</option>
                                <option value="Prints">üñºÔ∏è Prints</option>
                                <option value="Stickers">üè∑Ô∏è Stickers</option>
                                <option value="Custom">‚öôÔ∏è Custom</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label-enhanced">üí∞ Price ($)</label>
                            <input type="number" step="0.01" id="pw-price-manual" class="form-input" placeholder="0.00" />
                        </div>
                        <div class="form-group">
                            <label class="form-label-enhanced">üì¶ Initial Stock</label>
                            <input type="number" id="pw-qty-manual" class="form-input" value="10" min="0" />
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label-enhanced">üìã Description (optional)</label>
                        <textarea id="pw-description" class="form-input" rows="3" placeholder="Brief product description..."></textarea>
                    </div>
                </div>
            </section>
            
            <!-- Step 4: AI Assistance -->
            <section class="pw-panel hidden" data-step="4">
                <div class="step-header">
                    <h3>AI Product Enhancement</h3>
                    <p class="step-description">Let AI help optimize your product details</p>
                </div>
                
                <div class="ai-assistance">
                    <div class="form-group">
                        <label class="form-label-enhanced">üéØ Product Type Hint</label>
                        <input type="text" id="pw-type" class="form-input" placeholder="e.g., T-Shirt, Mug, Sticker" />
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label-enhanced">üí° Additional Context</label>
                        <input type="text" id="pw-hints" class="form-input" placeholder="Target audience, style, special features..." />
                    </div>
                    
                    <div class="ai-actions">
                        <button class="btn btn-primary" id="pw-suggest">
                            <span class="btn-icon">ü§ñ</span>Get AI Suggestions
                        </button>
                        <button class="btn btn-secondary" id="pw-skip-ai">Skip AI Assistance</button>
                    </div>
                    
                    <!-- (Removed duplicated CSV/AI batch + template buttons) -->
                </div>
            </section>
        </div>
    </div>

<!-- Bulk Creation Modal (CSV Import + AI Batch) -->
<div id="bulkCreationModal" class="modal-overlay" style="display:none;" aria-hidden="true" role="dialog" aria-modal="true">
    <div class="modal-content" style="max-width:980px;width:95vw;">
        <button class="modal-close-btn" id="closeBulkCreation" aria-label="Close bulk creation">√ó</button>
        <h2 style="margin-top:0;">Bulk Creation</h2>
        <div class="bulk-creation-tabs">
            <div class="tab-headers" style="display:flex;gap:.5rem;margin-bottom:1rem;">
                <button class="tab-header active" data-tab="csv" type="button">CSV / Excel Import</button>
                <button class="tab-header" data-tab="ai-batch" type="button">AI Batch Generation</button>
            </div>
            <!-- CSV TAB -->
            <div class="tab-content active" data-tab="csv">
                <div class="tab-section">
                    <h3>CSV & Excel Import</h3>
                    <p>Upload a CSV or Excel file with product data to create multiple products at once.</p>
                    <div class="csv-upload-area">
                        <div class="upload-section">
                            <div class="upload-dropzone" id="csvDropzone" role="button" tabindex="0" aria-label="Upload CSV or Excel file">
                                <div class="upload-content">
                                    <div class="upload-icon" aria-hidden="true">üìä</div>
                                    <h4>Drop CSV/Excel file or click to browse</h4>
                                    <p>Supports .csv, .xlsx, .xls ‚Ä¢ Max 10MB</p>
                                    <button class="btn btn-secondary" id="csvFileBtn" type="button">üìÅ Choose File</button>
                                    <input type="file" id="csvFileInput" accept=".csv,.xlsx,.xls" style="display:none;" />
                                </div>
                            </div>
                            <div class="csv-actions" style="margin-top: 20px; display:flex; gap:10px; flex-wrap:wrap; align-items:center;">
                                <label style="display:flex; gap:6px; align-items:center; font-weight:600;">Import as
                                    <select id="importCategory" class="form-input" style="height:34px; padding:2px 8px;">
                                        <option value="Products">Products</option>
                                        <option value="Materials" selected>Materials</option>
                                        <option value="Packing Materials">Packing Materials</option>
                                    </select>
                                </label>
                                <button class="btn btn-outline" id="downloadTemplate" type="button">üì• CSV Template</button>
                                <button class="btn btn-outline" id="downloadExcelTemplate" type="button">üì• Excel Template</button>
                                <button class="btn btn-outline" id="csvPreview" type="button" disabled>üëÄ Preview Data</button>
                                <button class="btn btn-primary" id="importCsvBtn" type="button" disabled>‚úÖ Import to Inventory</button>
                            </div>
                        </div>
                        <div class="csv-requirements">
                            <h4>File Format Requirements</h4>
                            <ul>
                                <li><strong>Required:</strong> name, category, price, stock</li>
                                <li><strong>Optional:</strong> description, sku, imageUrl, materials</li>
                                <li><strong>Materials:</strong> Separate multiple materials with semicolons</li>
                                <li><strong>Excel:</strong> Data must be in the first worksheet</li>
                            </ul>
                        </div>
                        <div id="csvPreviewSection" class="csv-preview" style="display:none;">
                            <h4>Data Preview</h4>
                            <div id="csvPreviewTable"></div>
                            <div class="csv-stats" style="display:flex;gap:1rem;align-items:center;flex-wrap:wrap;">
                                <span id="csvRowCount">0 products</span>
                                <span id="csvValidation" aria-live="polite">Validation pending...</span>
                                <span id="csvImportHint" class="text-muted" style="margin-left:auto;">Tip: choose correct import category.</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- AI BATCH TAB -->
            <div class="tab-content" data-tab="ai-batch">
                <div class="tab-section">
                    <h3>AI Batch Generation</h3>
                    <p>Let AI generate multiple product ideas based on your requirements.</p>
                    <div class="ai-batch-form">
                        <div class="form-row">
                            <div class="form-group">
                                <label for="batchTheme">Theme/Category</label>
                                <input type="text" id="batchTheme" class="form-input" placeholder="e.g., Space exploration, Vintage vibes, Minimalist" />
                            </div>
                            <div class="form-group">
                                <label for="batchCount">Number of Products</label>
                                <select id="batchCount" class="form-input">
                                    <option value="5">5 products</option>
                                    <option value="10" selected>10 products</option>
                                    <option value="15">15 products</option>
                                    <option value="20">20 products</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="batchCategory">Product Category</label>
                                <select id="batchCategory" class="form-input">
                                    <option value="mixed">Mixed Categories</option>
                                    <option value="Apparel">Apparel</option>
                                    <option value="Drinkware">Drinkware</option>
                                    <option value="Stickers">Stickers</option>
                                    <option value="Prints">Prints</option>
                                    <option value="Accessories">Accessories</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="batchPriceRange">Price Range</label>
                                <select id="batchPriceRange" class="form-input">
                                    <option value="budget">Budget ($5-15)</option>
                                    <option value="mid" selected>Mid-range ($15-35)</option>
                                    <option value="premium">Premium ($35-75)</option>
                                    <option value="luxury">Luxury ($75+)</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="batchDescription">Additional Requirements</label>
                            <textarea id="batchDescription" class="form-input" rows="3" placeholder="Target audience, style, special features..."></textarea>
                        </div>
                        <div class="ai-options">
                            <label class="checkbox-label"><input type="checkbox" id="generateImages" checked /> Generate product images with AI</label>
                            <label class="checkbox-label"><input type="checkbox" id="includeVariants" /> Create size/color variants</label>
                            <label class="checkbox-label"><input type="checkbox" id="autoPrice" /> Use AI-suggested pricing</label>
                        </div>
                        <div class="ai-batch-actions">
                            <button class="btn btn-primary btn-lg" id="generateBatch" type="button"><span class="btn-icon">ü§ñ</span>Generate Product Ideas</button>
                        </div>
                    </div>
                    <div id="batchResults" class="batch-results" style="display:none;">
                        <div class="results-header">
                            <h4>Generated Products</h4>
                            <div class="results-stats">
                                <span id="resultsCount">0 products generated</span>
                                <span id="resultsTime">Generated in 0s</span>
                            </div>
                        </div>
                        <div id="resultsGrid" class="results-grid"></div>
                        <div class="results-actions">
                            <button class="btn btn-outline" id="selectAllResults" type="button">Select All</button>
                            <button class="btn btn-outline" id="deselectAllResults" type="button">Deselect All</button>
                            <button class="btn btn-primary" id="createSelectedProducts" type="button">Create Selected Products</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="modal-actions">
            <button class="btn btn-secondary" id="cancelBulkCreation" type="button">Cancel</button>
            <button class="btn btn-primary" id="proceedBulkCreation" type="button" style="display:none;">Create Products</button>
        </div>
    </div>
</div>

<!-- External dependencies (moved to bottom for performance & CSP compliance). SheetJS loaded dynamically by assistant-bulk.js when needed. -->
<script src="https://cdn.jsdelivr.net/npm/dompurify@3.0.6/dist/purify.min.js" integrity="sha256-s4Wh05rq6ArlTc95xJMu38xpv8uKXuX4nHCqB6f+GOQ=" crossorigin="anonymous" nonce="<%= cspNonce %>"></script>
<script src="/js/assistant-core.js" defer nonce="<%= cspNonce %>"></script>
<script src="/js/assistant-bulk.js" defer nonce="<%= cspNonce %>"></script>
<script src="/js/assistant-extras.js" defer nonce="<%= cspNonce %>"></script>

<!-- End AI Assistant page -->
