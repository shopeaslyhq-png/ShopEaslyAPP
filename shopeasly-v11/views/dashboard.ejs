
<% layout('layout') %>

<style>
/* Simplified Dashboard Layout */
.dashboard-shell { display:flex; gap:1.25rem; align-items:stretch; }
@media (max-width:960px){ .dashboard-shell { flex-direction:column; } }
nav.dashboard-nav { flex:0 0 210px; background:var(--panel-bg,rgba(22,22,26,.55)); border:1px solid rgba(255,255,255,0.06); border-radius:12px; padding:1rem .85rem; backdrop-filter:blur(8px); position:sticky; top:70px; max-height:calc(100dvh - 90px); overflow:auto; }
@media (max-width:960px){ nav.dashboard-nav { position:static; max-height:none; display:flex; flex-direction:row; overflow:auto; } nav.dashboard-nav ul { flex-direction:row; flex-wrap:wrap; } }
nav.dashboard-nav h2 { font-size:.75rem; letter-spacing:1px; font-weight:600; opacity:.6; margin:0 0 .75rem; text-transform:uppercase; }
nav.dashboard-nav ul { list-style:none; margin:0; padding:0; display:flex; flex-direction:column; gap:.35rem; }
nav.dashboard-nav a { display:flex; align-items:center; gap:.55rem; padding:.55rem .65rem; font-size:.8rem; text-decoration:none; color:var(--text-primary,#fff); background:rgba(255,255,255,.04); border:1px solid rgba(255,255,255,.06); border-radius:8px; transition:.25s; }
nav.dashboard-nav a:hover, nav.dashboard-nav a:focus { background:rgba(59,130,246,.15); border-color:#3b82f6; outline:none; }
.dash-main { flex:1 1 auto; display:flex; flex-direction:column; gap:1.25rem; }
.brand-header { text-align:center; padding:1.25rem .5rem 0; }
.brand-header .logo { height:56px; width:auto; filter:drop-shadow(0 2px 6px rgba(0,0,0,.4)); }
.brand-header h1 { margin:.75rem 0 .35rem; font-size:1.65rem; letter-spacing:.5px; }
.brand-header p { margin:0; font-size:.8rem; opacity:.65; letter-spacing:.75px; text-transform:uppercase; }
.kpi-row { display:grid; grid-template-columns:repeat(auto-fit,minmax(140px,1fr)); gap:.75rem; }
.kpi { background:var(--panel-bg,rgba(28,28,32,.55)); border:1px solid rgba(255,255,255,0.07); border-radius:10px; padding:.75rem .8rem; display:flex; flex-direction:column; gap:.2rem; }
.kpi span.label { font-size:.6rem; letter-spacing:.75px; text-transform:uppercase; opacity:.6; font-weight:600; }
.kpi .value { font-size:1.1rem; font-weight:600; }
.cards-grid { display:grid; grid-template-columns:repeat(auto-fit,minmax(300px,1fr)); gap:1.1rem; align-items:start; }
.card { background:var(--panel-bg,rgba(24,24,28,.6)); border:1px solid rgba(255,255,255,0.07); border-radius:12px; padding:1rem .95rem 1.05rem; display:flex; flex-direction:column; gap:.65rem; position:relative; }
.card h2 { font-size:1rem; margin:0; display:flex; align-items:center; gap:.4rem; }
.empty { font-size:.75rem; opacity:.6; margin: .25rem 0 .35rem; }
table.simple { width:100%; border-collapse:collapse; font-size:.72rem; }
table.simple th, table.simple td { padding:.4rem .45rem; text-align:left; border-bottom:1px solid rgba(255,255,255,0.06); vertical-align:middle; }
table.simple th { font-size:.6rem; text-transform:uppercase; letter-spacing:.75px; opacity:.6; }
table.simple tbody tr:last-child td { border-bottom:none; }
.badge-status { display:inline-block; padding:.2rem .45rem; border-radius:6px; font-size:.55rem; font-weight:600; letter-spacing:.5px; }
.st-pending { background:#f59e0b22; color:#f8b84c; }
.st-processing { background:#3b82f622; color:#60a5fa; }
.st-delivered { background:#10b98122; color:#34d399; }
.alert-list { list-style:none; margin:0; padding:0; display:flex; flex-direction:column; gap:.35rem; max-height:230px; overflow:auto; }
.alert-list li { font-size:.65rem; line-height:1.25; display:flex; gap:.35rem; align-items:flex-start; }
.cta-link { margin-top:auto; font-size:.65rem; text-decoration:none; color:#3b82f6; font-weight:600; }
.ai-panel { display:flex; flex-direction:column; gap:.65rem; }
.ai-panel p { font-size:.7rem; margin:0; opacity:.75; }
.ai-quick { display:flex; flex-wrap:wrap; gap:.4rem; }
.ai-quick button { background:#1e3a8a; border:1px solid #1e40af; color:#fff; padding:.35rem .55rem; font-size:.6rem; border-radius:6px; cursor:pointer; line-height:1; } 
.ai-quick button:hover { background:#2563eb; border-color:#2563eb; }
/* Accessibility focus */
*:focus-visible { outline:2px solid #3b82f6; outline-offset:2px; }
</style>

<div class="dashboard-shell" aria-label="Dashboard Layout">
  <nav class="dashboard-nav" role="navigation" aria-label="Primary navigation">
    <h2>Menu</h2>
    <ul>
      <li><a href="/dashboard" aria-current="page">üè† Dashboard</a></li>
      <li><a href="/orders">üì¶ Orders</a></li>
      <li><a href="/inventory">üìä Inventory</a></li>
      <li><a href="/easly">ü§ñ AI Assistant</a></li>
    </ul>
  </nav>
  <main class="dash-main" id="main" tabindex="-1">
    <header class="brand-header" aria-label="Branding">
      <img src="/images/shopeasly-logo.png" alt="ShopEasly Logo" class="logo" />
      <h1>ShopEasly Operations</h1>
      <p>Unified Dashboard ‚Ä¢ Inventory ‚Ä¢ Orders ‚Ä¢ AI Copilot</p>
    </header>

    <!-- KPI Row -->
    <section class="kpi-row" aria-label="Key performance indicators">
      <div class="kpi"><span class="label">Total Orders</span><div class="value"><%= stats?.totalOrders ?? (orders? orders.length:0) %></div></div>
      <div class="kpi"><span class="label">Pending</span><div class="value"><%= stats?.pendingOrders ?? 0 %></div></div>
      <div class="kpi"><span class="label">Processing</span><div class="value"><%= stats?.processingOrders ?? 0 %></div></div>
      <div class="kpi"><span class="label">Delivered</span><div class="value"><%= stats?.deliveredOrders ?? 0 %></div></div>
      <div class="kpi"><span class="label">SKUs</span><div class="value"><%= stats?.inventory?.totalSkus ?? 0 %></div></div>
      <div class="kpi"><span class="label">Low Stock</span><div class="value"><%= stats?.inventory?.lowStockCount ?? 0 %></div></div>
      <div class="kpi"><span class="label">Out of Stock</span><div class="value"><%= stats?.inventory?.outOfStockCount ?? 0 %></div></div>
    </section>

    <div class="cards-grid" aria-label="Core feature panels">
      <!-- Recent Orders -->
      <section class="card" aria-labelledby="recent-orders-h2">
        <h2 id="recent-orders-h2">üì¶ Recent Orders</h2>
        <% if (orders && orders.length) { %>
          <div class="table-wrapper" style="overflow:auto; max-height:240px;">
            <table class="simple" aria-describedby="recent-orders-h2">
              <thead><tr><th>ID</th><th>Customer</th><th>Product</th><th>Status</th><th>Date</th></tr></thead>
              <tbody>
                <% orders.slice(0,6).forEach(o=> { %>
                  <tr>
                    <td><%= o.id ? o.id.slice(0,6) : '‚Äî' %></td>
                    <td><%= o.customerName || '‚Äî' %></td>
                    <td><%= o.product || '‚Äî' %></td>
                    <td>
                      <% const st = (o.status||'Pending').toLowerCase(); %>
                      <span class="badge-status <%= st==='delivered'?'st-delivered': st==='processing'?'st-processing':'st-pending' %>"><%= o.status || 'Pending' %></span>
                    </td>
                    <td><%= o.date || (o.createdAt ? new Date(o.createdAt._seconds*1000).toLocaleDateString(): '‚Äî') %></td>
                  </tr>
                <% }) %>
              </tbody>
            </table>
          </div>
        <% } else { %>
          <div class="empty">No orders yet. <a href="/orders/new">Create your first order</a>.</div>
        <% } %>
        <a class="cta-link" href="/orders">View all orders ‚Üí</a>
      </section>

      <!-- Inventory Alerts -->
      <section class="card" aria-labelledby="inv-alerts-h2">
        <h2 id="inv-alerts-h2">üìä Inventory Alerts</h2>
        <% const low = summary?.inventory?.lowStockItems || []; const out = summary?.inventory?.outOfStockItems || []; const mergedAlerts = [...out, ...low].slice(0,8); %>
        <% if (mergedAlerts.length) { %>
          <ul class="alert-list" aria-live="polite">
            <% mergedAlerts.forEach(it=> { %>
              <li>
                <% const icon = out.find(o=>o.sku===it.sku) ? '‚ùå' : '‚ö†Ô∏è'; %>
                <span><%= icon %></span>
                <span><strong><%= it.name %></strong> (<%= it.sku %>) ‚Äî <%= it.stock %> <%= it.stock===0?'left':'in stock' %></span>
              </li>
            <% }) %>
          </ul>
        <% } else { %>
          <div class="empty">No low / out-of-stock alerts.</div>
        <% } %>
        <a class="cta-link" href="/inventory">Go to inventory ‚Üí</a>
      </section>

      <!-- AI Assistant -->
      <section class="card ai-panel" aria-labelledby="ai-panel-h2">
        <h2 id="ai-panel-h2">ü§ñ AI Copilot</h2>
        <p>Ask about orders, stock levels, or generate product ideas. Your AI assistant is always available.</p>
        <div class="ai-quick" aria-label="Quick AI prompts">
          <button type="button" data-ai-prompt="Inventory summary">Inventory Summary</button>
          <button type="button" data-ai-prompt="Pending orders list">Pending Orders</button>
          <button type="button" data-ai-prompt="Show low stock items">Low Stock</button>
          <button type="button" data-ai-prompt="Start design brainstorm">Brainstorm</button>
        </div>
        <a class="cta-link" href="/easly" aria-label="Open full AI assistant interface">Open full assistant ‚Üí</a>
      </section>
    </div>
  </main>
</div>

<script>
// Minimal delegated handler for AI quick prompts ‚Äì reuse existing assistant endpoint
document.addEventListener('click', e=>{
  const btn = e.target.closest('[data-ai-prompt]');
  if(!btn) return;
  const prompt = btn.getAttribute('data-ai-prompt');
  if(!prompt) return;
  btn.disabled = true; btn.style.opacity='.6';
  fetch('/ai/co-pilot', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ textPart: prompt, clientId: 'dash_'+(localStorage.getItem('easlyClientId')||'anon') })})
    .finally(()=> { btn.disabled=false; btn.style.opacity='1'; });
});
</script>
<!-- End dashboard main script -->

