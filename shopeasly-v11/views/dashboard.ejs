
<% layout('layout') %>




<!-- HERO SECTION -->
<section class="dashboard-hero">
    <div class="dashboard-hero-bg"></div>
    <div class="dashboard-hero-content">
        <img src="/images/shopeasly-logo.png" alt="ShopEasly Logo" class="logo-img-xl" />
        <h1 class="dashboard-title">Welcome to ShopEasly</h1>
        <p class="dashboard-subtitle">
            Operations and order fulfillment dashboard
        </p>
    </div>
</section>
<div class="page-container">


<!-- STORAGE STATUS -->
<section style="margin-bottom: 2rem;">
    <div class="status success">
        Local Storage
    </div>
    <% if (typeof error !== 'undefined' && error) { %>
      <div class="status error"><small><%= error %></small></div>
    <% } %>
</section>

<!-- FEATURE TILES: Big buttons for Orders, Inventory, AI -->
<section class="feature-tiles" style="margin-bottom: 1.5rem;">
    <a href="/orders" class="feature-tile" aria-label="Go to Orders">
        <div class="feature-head">
            <div class="feature-icon">üì¶</div>
            <h3>Orders</h3>
        </div>
        <div class="feature-meta">
            <span>Total: <strong><%= stats?.totalOrders ?? 0 %></strong></span>
            <span>Pending: <strong><%= stats?.pendingOrders ?? 0 %></strong></span>
            <span>Processing: <strong><%= stats?.processingOrders ?? 0 %></strong></span>
        </div>
        <% if (orders && orders.length) { %>
            <div class="feature-sub">
                <small>Latest: <%= orders[0].customerName || 'Customer' %> ‚Ä¢ <%= orders[0].product || 'Product' %></small>
            </div>
        <% } %>
    </a>

    <a href="/inventory" class="feature-tile" aria-label="Go to Inventory">
        <div class="feature-head">
            <div class="feature-icon">üìä</div>
            <h3>Inventory</h3>
        </div>
        <div class="feature-meta">
            <span>SKUs: <strong><%= stats?.inventory?.totalSkus ?? 0 %></strong></span>
            <span>Low: <strong><%= stats?.inventory?.lowStockCount ?? 0 %></strong></span>
            <span>Out: <strong><%= stats?.inventory?.outOfStockCount ?? 0 %></strong></span>
        </div>
        <ul class="feature-list">
            <% 
              const ls = (summary?.inventory?.lowStockItems || []).slice(0,3);
              const os = (summary?.inventory?.outOfStockItems || []).slice(0,3);
              const merged = [...ls, ...os].slice(0,3);
              if (merged.length === 0) { 
            %>
                <li><small>No alerts. All good.</small></li>
            <% } else { merged.forEach(item => { %>
                <li><small><%= item.category || '‚Äî' %> ‚Äî <strong><%= item.name %></strong> ‚Ä¢ Qty: <%= item.stock %></small></li>
            <% }) } %>
        </ul>
    </a>

    <a href="/easly" class="feature-tile" aria-label="Open Easly AI">
        <div class="feature-head">
            <div class="feature-icon">ü§ñ</div>
            <h3>Easly AI</h3>
        </div>
        <p class="feature-welcome">Hi, I‚Äôm Easly AI. Tap to get help with orders, inventory, and quick actions.</p>
        <div class="feature-cta">Open Assistant ‚Üí</div>
    </a>
</section>

<!-- STATS GRID -->
<section class="stats-grid">
    <div class="stat-card glass">
        <h3>Total Orders</h3>
        <p><%= (typeof stats !== 'undefined' && stats.totalOrders != null) ? stats.totalOrders : (Array.isArray(orders) ? orders.length : 0) %></p>
    </div>
    <div class="stat-card glass"><h3>Pending Orders</h3><p><%= stats?.pendingOrders ?? 0 %></p></div>
    <div class="stat-card glass"><h3>Processing</h3><p><%= stats?.processingOrders ?? 0 %></p></div>
    <div class="stat-card glass"><h3>Delivered</h3><p><%= stats?.deliveredOrders ?? 0 %></p></div>
    <div class="stat-card glass"><h3>Total SKUs</h3><p><%= stats?.inventory?.totalSkus ?? 0 %></p></div>
    <div class="stat-card glass"><h3>Low Stock</h3><p><%= stats?.inventory?.lowStockCount ?? 0 %></p></div>
    <div class="stat-card glass"><h3>Out of Stock</h3><p><%= stats?.inventory?.outOfStockCount ?? 0 %></p></div>
</section>

<div class="dashboard-grid">
    <!-- RECENT ORDERS TABLE -->
    <section class="dashboard-card">
        <h2>Recent Orders</h2>
        <% if (orders && orders.length) { %>
            <div class="table-wrapper" aria-label="Recent Orders Table">
                <table>
                    <thead>
                        <tr>
                            <th>Order ID</th>
                            <th>Customer</th>
                            <th>Product</th>
                            <th>Status</th>
                            <th>Date</th>
                        </tr>
                    </thead>
                    <tbody>
                        <% orders.slice(0, 5).forEach(order => { %>
                            <tr>
                                <td><%= order.id ? order.id.slice(0,8) + '‚Ä¶' : 'N/A' %></td>
                                <td><%= order.customerName || 'N/A' %></td>
                                <td><%= order.product || 'N/A' %></td>
                                <td>
                                    <span class="status-badge <%= order.status === 'Delivered' ? 'completed' : order.status === 'Processing' ? 'in-production' : 'new' %>">
                                        <%= order.status || 'Pending' %>
                                    </span>
                                </td>
                                <td>
                                    <%= order.date || (order.createdAt ? new Date(order.createdAt._seconds*1000).toLocaleDateString() : 'N/A') %>
                                </td>
                            </tr>
                        <% }) %>
                    </tbody>
                </table>
            </div>
        <% } else { %>
            <div class="empty-state-small">
                <p>No orders yet. <a href="/orders/new">Create your first order.</a></p>

            </div>
        <% } %>
    </section>

        <!-- Inventory Alerts -->
        <section class="dashboard-card">
                <h2>Inventory Alerts</h2>
                <% if (summary && summary.inventory && (summary.inventory.lowStockItems.length || summary.inventory.outOfStockItems.length)) { %>
                    <% if (summary.inventory.outOfStockItems.length) { %>
                        <div class="status error" style="margin-bottom: .75rem;">
                            <strong><%= summary.inventory.outOfStockItems.length %></strong> item(s) out of stock
                        </div>
                        <ul class="list-unstyled" style="margin-bottom: 1rem;">
                            <% summary.inventory.outOfStockItems.slice(0,5).forEach(it => { %>
                                <li>‚ùå <strong><%= it.name %></strong> (<%= it.sku %>) ‚Äî stock: <%= it.stock %></li>
                            <% }) %>
                        </ul>
                    <% } %>
                    <% if (summary.inventory.lowStockItems.length) { %>
                        <div class="status warning" style="margin-bottom: .75rem;">
                            <strong><%= summary.inventory.lowStockItems.length %></strong> item(s) low on stock
                        </div>
                        <ul class="list-unstyled">
                            <% summary.inventory.lowStockItems.slice(0,5).forEach(it => { %>
                                <li>‚ö†Ô∏è <strong><%= it.name %></strong> (<%= it.sku %>) ‚Äî stock: <%= it.stock %> (threshold: <%= it.threshold %>)</li>
                            <% }) %>
                        </ul>
                    <% } %>
                <% } else { %>
                    <div class="empty-state-small"><p>No alerts right now.</p></div>
                <% } %>
        </section>

    <!-- AI ASSISTANT PANEL -->
    <section class="dashboard-card">
        <h2>ü§ñ Easly AI</h2>
        <p>Your AI co-pilot is ready to help with tasks, inventory, and insights.</p>
        <div class="quick-actions">
            <a href="/easly" class="btn btn-primary">Open AI Assistant</a>
        </div>
    </section>

    <!-- QUICK ACTIONS -->
    <section class="dashboard-card">
        <h2>Quick Actions</h2>
        <div class="quick-actions">
            <a href="/orders" class="btn btn-primary">üì¶ View All Orders</a>
            <a href="/orders/new" class="btn btn-primary" style="background-color: var(--success);">‚ûï Create New Order</a>
            <a href="/inventory" class="btn btn-secondary">üìä Manage Inventory</a>
            <a href="/easly" class="btn btn-secondary">ü§ñ Easly AI</a>
        </div>
    </section>
</div>

<!-- BUSINESS ANALYTICS -->
<section class="analytics-section">
    <div class="section-header">
        <h2>üìä Analytics</h2>
        <div class="analytics-controls">
            <select id="timeRange" class="form-input">
                <option value="7">Last 7 days</option>
                <option value="30" selected>Last 30 days</option>
                <option value="90">Last 90 days</option>
            </select>
            <button class="btn btn-secondary" onclick="refreshAnalytics()">üîÑ Refresh</button>
        </div>
    </div>
    <div class="charts-grid">
    <!-- Sales Trend chart removed for no-scroll layout -->
        <div class="chart-card"><h3>üìä Order Status</h3><p class="chart-subtitle" style="color: var(--text-secondary); margin: 0.25rem 0 0.5rem;"><span id="totalOrdersCount">0 orders</span></p><canvas id="orderStatusChart"></canvas></div>
        <div class="chart-card"><h3>üèÜ Top Products</h3><p class="chart-subtitle" style="color: var(--text-secondary); margin: 0.25rem 0 0.5rem;"><span id="topProductsCount">0 products</span></p><canvas id="topProductsChart"></canvas></div>
    <!-- Revenue chart removed for no-scroll layout -->
    </div>
</section>

<!-- PERFORMANCE METRICS -->
<section class="metrics-section">
    <div class="section-header" style="margin-bottom:0.5rem;">
        <h2 style="font-size:1.2rem; margin:0;">‚ö° Key Metrics</h2>
    </div>
    <div style="display:flex;gap:1.5rem;flex-wrap:wrap;align-items:center;justify-content:space-between;padding:0.5rem 0 1rem 0;">
        <span style="font-weight:600;">Low Stock: <span id="lowStockCount"><%= stats?.inventory?.lowStockCount ?? 0 %></span></span>
        <span style="font-weight:600;">Out of Stock: <span id="outOfStockCount"><%= stats?.inventory?.outOfStockCount ?? 0 %></span></span>
        <span style="font-weight:600;">Pending Orders: <span id="pendingOrders"><%= stats?.pendingOrders ?? 0 %></span></span>
        <span style="font-weight:600;">Processing: <span id="processingOrders"><%= stats?.processingOrders ?? 0 %></span></span>
        <span style="font-weight:600;">Delivered: <span id="deliveredOrders"><%= stats?.deliveredOrders ?? 0 %></span></span>
    </div>
</section>
</div>

<%
  // Safely serialize dashboard data for inline JS
  const __dashboardData = JSON.stringify({
    orders: typeof orders !== 'undefined' ? orders : [],
    stats: typeof stats !== 'undefined' ? stats : {}
  });
  // Prevent </script> breaks and XSS by escaping the < char
  const __dashboardDataEscaped = __dashboardData.replace(/</g, '\\u003c');
%>

<script>
// Dashboard Analytics and Charts
class DashboardAnalytics {
    constructor() {
        this.charts = {};
        this.data = JSON.parse('<%- __dashboardDataEscaped %>');
        this.init();
    }

    init() {
        this.setupCharts();
        this.updateMetrics();
        this.startRealTimeUpdates();
    }

    setupCharts() {
    // Order Status Distribution Chart
    this.createOrderStatusChart();

    // Top Products Chart
    this.createTopProductsChart();
        const statusCounts = {
            'Pending': 0,
            'Processing': 0,
            'Shipped': 0,
            'Delivered': 0
        };

        this.data.orders.forEach(order => {
            const status = order.status || 'Pending';
            if (statusCounts.hasOwnProperty(status)) {
                statusCounts[status]++;
            } else {
                statusCounts['Pending']++;
            }
        });

        this.charts.orderStatus = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: Object.keys(statusCounts),
                datasets: [{
                    data: Object.values(statusCounts),
                    backgroundColor: [
                        '#f59e0b', // Pending - Amber
                        '#3b82f6', // Processing - Blue
                        '#8b5cf6', // Shipped - Purple
                        '#10b981'  // Delivered - Green
                    ],
                    borderWidth: 0
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: {
                            padding: 20,
                            usePointStyle: true
                        }
                    }
                }
            }
        });

        // Update total orders count
        const elTotalOrders = document.getElementById('totalOrdersCount'); if (elTotalOrders) elTotalOrders.textContent = `${this.data.orders.length} orders`;
    }

    createTopProductsChart() {
        const ctx = document.getElementById('topProductsChart').getContext('2d');

        // Calculate product popularity
        const productCounts = {};
        this.data.orders.forEach(order => {
            const product = order.product || 'Unknown Product';
            productCounts[product] = (productCounts[product] || 0) + 1;
        });

        // Get top 5 products
        const sortedProducts = Object.entries(productCounts)
            .sort(([,a], [,b]) => b - a)
            .slice(0, 5);

        const labels = sortedProducts.map(([product]) => product.length > 15 ? product.substring(0, 15) + '...' : product);
        const data = sortedProducts.map(([,count]) => count);

        this.charts.topProducts = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Orders',
                    data: data,
                    backgroundColor: 'rgba(99, 102, 241, 0.8)',
                    borderColor: 'rgb(99, 102, 241)',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        grid: {
                            color: 'rgba(0, 0, 0, 0.1)'
                        }
                    },
                    x: {
                        grid: {
                            display: false
                        }
                    }
                }
            }
        });

        const elTop = document.getElementById('topProductsCount'); if (elTop) elTop.textContent = `${Object.keys(productCounts).length} products`;
    }


    updateMetrics() {
        // Calculate and update KPI metrics
        const orders = this.data.orders;

        // Average Order Value
        const totalValue = orders.reduce((sum, order) => {
            const value = parseFloat(order.total) || Math.floor(Math.random() * 200) + 50;
            return sum + value;
        }, 0);
        const avgOrderValue = orders.length > 0 ? totalValue / orders.length : 0;
        document.getElementById('avgOrderValue').textContent = '$' + avgOrderValue.toFixed(2);

        // Conversion Rate (simulated)
        const conversionRate = Math.floor(Math.random() * 15) + 10;
        document.getElementById('conversionRate').textContent = conversionRate + '%';

        // Processing Time (simulated)
        const processingHours = Math.floor(Math.random() * 24) + 12;
        document.getElementById('processingTime').textContent = processingHours + 'h';

        // Customer Satisfaction (simulated)
        const satisfaction = Math.floor(Math.random() * 10) + 85;
        document.getElementById('customerSat').textContent = satisfaction + '%';
    }

    startRealTimeUpdates() {
        // Update metrics every 30 seconds
        setInterval(() => {
            this.updateMetrics();
        }, 30000);
    }
}

// Global functions
function refreshDashboard() {
    location.reload();
}

function refreshAnalytics() {
    if (window.dashboardAnalytics) {
        window.dashboardAnalytics.updateMetrics();

        // Show refresh animation
        const refreshBtn = event.target.closest('button');
        const icon = refreshBtn.querySelector('.refresh-icon');
        icon.style.animation = 'spin 1s linear';
        setTimeout(() => {
            icon.style.animation = '';
        }, 1000);
    }
}

// Initialize dashboard when DOM is loaded
document.addEventListener('DOMContentLoaded', function() {
    window.dashboardAnalytics = new DashboardAnalytics();

    // Optional smooth scroll to analytics only when explicitly requested via hash
    const analyticsSection = document.querySelector('.analytics-section');
    if (analyticsSection && window.location.hash === '#analytics') {
        analyticsSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }
});

// Add CSS animation for refresh icon
const style = document.createElement('style');
style.textContent = `
    @keyframes spin {
        from { transform: rotate(0deg); }
        to { transform: rotate(360deg); }
    }
`;
document.head.appendChild(style);
</script>


