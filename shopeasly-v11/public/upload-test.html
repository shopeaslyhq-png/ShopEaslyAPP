<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Excel Upload Test</title>
    <script src="https://unpkg.com/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        
        .test-container {
            background: white;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }
        
        .upload-area {
            border: 3px dashed #007bff;
            border-radius: 12px;
            padding: 40px;
            text-align: center;
            background: #f8f9fa;
            margin: 20px 0;
            transition: all 0.3s ease;
        }
        
        .upload-area:hover {
            border-color: #0056b3;
            background: #e3f2fd;
        }
        
        .upload-area.dragover {
            border-color: #28a745;
            background: #d4edda;
        }
        
        .upload-btn {
            background: #007bff;
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            margin: 10px;
            transition: all 0.3s ease;
        }
        
        .upload-btn:hover {
            background: #0056b3;
            transform: translateY(-2px);
        }
        
        .template-btn {
            background: #28a745;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            font-size: 14px;
            cursor: pointer;
            margin: 5px;
        }
        
        .template-btn:hover {
            background: #218838;
        }
        
        .results {
            margin-top: 20px;
            padding: 20px;
            background: #e8f5e8;
            border-radius: 8px;
            border-left: 4px solid #28a745;
        }
        
        .error {
            background: #f8d7da;
            border-left-color: #dc3545;
            color: #721c24;
        }
        
        .preview-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }
        
        .preview-table th,
        .preview-table td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        
        .preview-table th {
            background: #f8f9fa;
            font-weight: bold;
        }
        
        .stats {
            display: flex;
            gap: 20px;
            margin: 15px 0;
        }
        
        .stat-item {
            background: #007bff;
            color: white;
            padding: 10px 15px;
            border-radius: 6px;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>üìä Excel/CSV Upload Test</h1>
        <p>This page tests the Excel and CSV upload functionality independently.</p>
        
        <div class="upload-area" id="uploadArea">
            <div style="font-size: 48px; margin-bottom: 15px;">üìä</div>
            <h3>Drop Excel/CSV files here or click to browse</h3>
            <p>Supports .xlsx, .xls, .csv files</p>
            <button class="upload-btn" id="uploadBtn">üìÅ Choose File</button>
            <input type="file" id="fileInput" accept=".csv,.xlsx,.xls" style="display: none;">
        </div>
        
        <div style="text-align: center; margin: 20px 0;">
            <button class="template-btn" id="downloadCsvTemplate">üì• Download CSV Template</button>
            <button class="template-btn" id="downloadExcelTemplate">üì• Download Excel Template</button>
        </div>
        
        <div id="results" style="display: none;"></div>
    </div>

    <script>
        const uploadArea = document.getElementById('uploadArea');
        const uploadBtn = document.getElementById('uploadBtn');
        const fileInput = document.getElementById('fileInput');
        const results = document.getElementById('results');
        const downloadCsvBtn = document.getElementById('downloadCsvTemplate');
        const downloadExcelBtn = document.getElementById('downloadExcelTemplate');

        // File upload handlers
        uploadBtn.addEventListener('click', () => fileInput.click());
        fileInput.addEventListener('change', (e) => {
            if (e.target.files[0]) {
                handleFileUpload(e.target.files[0]);
            }
        });

        // Drag and drop
        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });

        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('dragover');
        });

        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            
            const files = e.dataTransfer.files;
            if (files[0]) {
                handleFileUpload(files[0]);
            }
        });

        // Handle file upload
        function handleFileUpload(file) {
            showResults(`Processing file: ${file.name}...`, false);
            
            const fileExtension = file.name.split('.').pop().toLowerCase();
            
            if (fileExtension === 'csv') {
                handleCSV(file);
            } else if (fileExtension === 'xlsx' || fileExtension === 'xls') {
                handleExcel(file);
            } else {
                showResults(`Unsupported file type: ${fileExtension}`, true);
            }
        }

        // Handle CSV files
        function handleCSV(file) {
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const csvText = e.target.result;
                    const data = parseCSV(csvText);
                    displayResults(data, 'CSV');
                } catch (error) {
                    showResults(`CSV parsing error: ${error.message}`, true);
                }
            };
            reader.readAsText(file);
        }

        // Handle Excel files
        function handleExcel(file) {
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const arrayBuffer = e.target.result;
                    const workbook = XLSX.read(arrayBuffer, { type: 'array' });
                    
                    const sheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[sheetName];
                    const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
                    
                    if (jsonData.length < 2) {
                        throw new Error('File must have at least a header row and one data row');
                    }
                    
                    const headers = jsonData[0].map(h => String(h || '').trim());
                    const data = [];
                    
                    for (let i = 1; i < jsonData.length; i++) {
                        const values = jsonData[i];
                        const row = {};
                        
                        headers.forEach((header, index) => {
                            row[header] = String(values[index] || '').trim();
                        });
                        
                        if (Object.values(row).some(val => val.trim())) {
                            data.push(row);
                        }
                    }
                    
                    displayResults({ headers, data }, `Excel (${sheetName})`);
                    
                } catch (error) {
                    showResults(`Excel parsing error: ${error.message}`, true);
                }
            };
            reader.readAsArrayBuffer(file);
        }

        // Parse CSV
        function parseCSV(csvText) {
            const lines = csvText.split('\n').filter(line => line.trim());
            if (lines.length < 2) {
                throw new Error('CSV must have at least a header and one data row');
            }
            
            const headers = lines[0].split(',').map(h => h.trim().replace(/"/g, ''));
            const data = [];
            
            for (let i = 1; i < lines.length; i++) {
                const values = lines[i].split(',').map(v => v.trim().replace(/"/g, ''));
                const row = {};
                
                headers.forEach((header, index) => {
                    row[header] = values[index] || '';
                });
                
                data.push(row);
            }
            
            return { headers, data };
        }

        // Display results
        function displayResults(parsedData, fileType) {
            const { headers, data } = parsedData;
            
            let html = `
                <div class="results">
                    <h3>‚úÖ ${fileType} File Loaded Successfully!</h3>
                    <div class="stats">
                        <div class="stat-item">üìä ${data.length} products found</div>
                        <div class="stat-item">üìã ${headers.length} columns</div>
                    </div>
                    <h4>Column Headers:</h4>
                    <p><strong>${headers.join(', ')}</strong></p>
            `;
            
            if (data.length > 0) {
                html += `
                    <h4>Data Preview (first 3 rows):</h4>
                    <table class="preview-table">
                        <thead>
                            <tr>${headers.map(h => `<th>${h}</th>`).join('')}</tr>
                        </thead>
                        <tbody>
                `;
                
                data.slice(0, 3).forEach(row => {
                    html += `<tr>${headers.map(h => `<td>${row[h] || ''}</td>`).join('')}</tr>`;
                });
                
                html += `
                        </tbody>
                    </table>
                `;
            }
            
            html += '</div>';
            results.innerHTML = html;
            results.style.display = 'block';
        }

        // Show results
        function showResults(message, isError = false) {
            results.innerHTML = `<div class="results ${isError ? 'error' : ''}">${message}</div>`;
            results.style.display = 'block';
        }

        // Template downloads
        downloadCsvBtn.addEventListener('click', () => {
            const template = `name,category,price,stock,description,sku,imageUrl,materials
"Cool Space T-Shirt","Apparel","25.00","50","Amazing space-themed design","APP-COOL-001","","Cotton T-Shirt;Fabric Paint"
"Galaxy Coffee Mug","Drinkware","18.50","30","Perfect for space lovers","DRK-GAL-002","","Ceramic Mug"
"Retro Sticker Pack","Stickers","8.99","100","Vintage space stickers","STK-RET-003","","Vinyl Sticker Paper"`;
            
            const blob = new Blob([template], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'product-template.csv';
            a.click();
            window.URL.revokeObjectURL(url);
        });

        downloadExcelBtn.addEventListener('click', () => {
            try {
                const wb = XLSX.utils.book_new();
                const data = [
                    ['name', 'category', 'price', 'stock', 'description', 'sku', 'imageUrl', 'materials'],
                    ['Cool Space T-Shirt', 'Apparel', 25.00, 50, 'Amazing space-themed design', 'APP-COOL-001', '', 'Cotton T-Shirt;Fabric Paint'],
                    ['Galaxy Coffee Mug', 'Drinkware', 18.50, 30, 'Perfect for space lovers', 'DRK-GAL-002', '', 'Ceramic Mug'],
                    ['Retro Sticker Pack', 'Stickers', 8.99, 100, 'Vintage space stickers', 'STK-RET-003', '', 'Vinyl Sticker Paper']
                ];
                
                const ws = XLSX.utils.aoa_to_sheet(data);
                ws['!cols'] = [
                    { wch: 20 }, { wch: 12 }, { wch: 8 }, { wch: 8 },
                    { wch: 30 }, { wch: 15 }, { wch: 20 }, { wch: 25 }
                ];
                
                XLSX.utils.book_append_sheet(wb, ws, 'Products');
                XLSX.writeFile(wb, 'product-template.xlsx');
                
            } catch (error) {
                showResults(`Error creating Excel template: ${error.message}`, true);
            }
        });
    </script>
</body>
</html>